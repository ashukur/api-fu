<!DOCTYPE html>
<html>
    <head>
        <style>
            body {
                height: 100%;
                margin: 0;
                font-family: sans-serif;
                padding: 20px;
            }
            header {
                margin: 0;
            }
            #graphiql {
                border: 1px solid #606060;
                height: 700px;
            }
        </style>

        <script src="//cdn.jsdelivr.net/es6-promise/4.0.5/es6-promise.auto.min.js"></script>
        <script src="//cdn.jsdelivr.net/fetch/0.9.0/fetch.min.js"></script>
        <script src="//cdn.jsdelivr.net/react/15.4.2/react.min.js"></script>
        <script src="//cdn.jsdelivr.net/react/15.4.2/react-dom.min.js"></script>

        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/graphiql@0.12.0/graphiql.min.css" />
        <script src="//cdn.jsdelivr.net/npm/graphiql@0.12.0/graphiql.min.js"></script>
    </head>
    <body>
        <header>
            <form>
                <p>
                    Handle: <input id="handle" autocomplete="username" type="text" oninput="storeInputValue(this);" />
                    Password: <input id="password" autocomplete="current-password" type="password" oninput="storeInputValue(this);" />
                </p>
            </form>

            <script type="text/javascript">
                function storeInputValue(e) {
                    localStorage.setItem(e.id, e.value);
                }

                function restoreInputValue(id) {
                    var v = localStorage.getItem(id);
                    if (v !== null) {
                        document.getElementById(id).value = v;
                    }
                }

                restoreInputValue('handle');
                restoreInputValue('password');
            </script>
        </header>
        <div id="graphiql">Loading...</div>
        <script>
            function httpGraphQLFetcher(graphQLParams) {
                var headers = {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                };

                const handle = document.getElementById('handle').value;
                const password = document.getElementById('password').value;
                if (handle && password) {
                    headers['Authorization'] = 'Basic ' + window.btoa(handle + ":" + password);
                }

                const l = window.location;
                return fetch('/graphql', {
                    method: 'post',
                    headers: headers,
                    body: JSON.stringify(graphQLParams),
                }).then(function (response) {
                    return response.text();
                }).then(function (responseBody) {
                    try {
                        return JSON.parse(responseBody);
                    } catch (error) {
                        return responseBody;
                    }
                });
            }

            function renderGraphiQL() {
                ReactDOM.render(
                    React.createElement(GraphiQL, {
                        fetcher: httpGraphQLFetcher,
                    }),
                    document.getElementById('graphiql')
                );
            }
            renderGraphiQL();
        </script>
    </body>
</html>
